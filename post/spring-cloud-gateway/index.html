<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spring Cloud Gateway响应式网关 - Gordon的IT技术文档</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Gordon" />
  <meta name="description" content="前言 随着Zuul 1.0的不再维护，Spring官方开发了基于WebFlux编程模型的Spring Cloud Gateway来作为微服务的网关。 WebF" />

  <meta name="keywords" content="Gordon的IT技术文档" />






<meta name="generator" content="Hugo 0.59.1" />


<link rel="canonical" href="/post/spring-cloud-gateway/" />



<link rel="icon" href="/img/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Spring Cloud Gateway响应式网关" />
<meta property="og:description" content="前言 随着Zuul 1.0的不再维护，Spring官方开发了基于WebFlux编程模型的Spring Cloud Gateway来作为微服务的网关。 WebF" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/spring-cloud-gateway/" />
<meta property="article:published_time" content="2019-12-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-12-26T00:00:00+00:00" />
<meta itemprop="name" content="Spring Cloud Gateway响应式网关">
<meta itemprop="description" content="前言 随着Zuul 1.0的不再维护，Spring官方开发了基于WebFlux编程模型的Spring Cloud Gateway来作为微服务的网关。 WebF">


<meta itemprop="datePublished" content="2019-12-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-12-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3302">



<meta itemprop="keywords" content="Spring," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Cloud Gateway响应式网关"/>
<meta name="twitter:description" content="前言 随着Zuul 1.0的不再维护，Spring官方开发了基于WebFlux编程模型的Spring Cloud Gateway来作为微服务的网关。 WebF"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Gordon的IT技术文档</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Gordon的IT技术文档
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Spring Cloud Gateway响应式网关</h1>
      
      <div class="post-meta">
        <time datetime="2019-12-26" class="post-time">
          2019-12-26
        </time>
        <div class="post-category">
            <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"> 微服务 </a>
            
          </div>
        <span class="more-meta"> 约 3302 字 </span>
          <span class="more-meta"> 预计阅读 7 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#前言">前言</a>
<ul>
<li><a href="#过滤器">过滤器</a></li>
<li><a href="#断言">断言</a></li>
<li><a href="#路由">路由</a></li>
</ul></li>
<li><a href="#实践">实践</a>
<ul>
<li><a href="#引入相关依赖">引入相关依赖</a></li>
<li><a href="#自定义一个新的路由">自定义一个新的路由</a></li>
<li><a href="#跨域配置">跨域配置</a></li>
<li><a href="#自定义一个断言">自定义一个断言</a></li>
<li><a href="#自定义一个过滤器">自定义一个过滤器</a></li>
<li><a href="#动态路由配置">动态路由配置</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="前言">前言</h1>

<p>随着Zuul 1.0的不再维护，Spring官方开发了基于WebFlux编程模型的Spring Cloud Gateway来作为微服务的网关。</p>

<p>WebFlux是随着Spring5推出的响应式编程框架，底层是基于Netty、Reactor Core、Reactive Streams等技术，同时也大量使用到了函数式编程范式。</p>

<p>Spring Cloud Gateway里有<code>三个</code>核心的概念：</p>

<ol>
<li>过滤器</li>
<li>断言</li>
<li>路由</li>
</ol>

<h2 id="过滤器">过滤器</h2>

<p>Spring Cloud Gateway做为网关，是通过一系列的过滤器对请求和响应进行处理，这些过滤器形成了一个链条，称之为过滤器链。</p>

<p>Spring Cloud Gateway的过滤器分为两种：</p>

<ul>
<li><p>全局过滤器</p></li>

<li><p>局部过滤器</p></li>
</ul>

<p>顾名思义，全局过滤器回作用到每一个请求上，而局部过滤器只作用于配置了的路由上。</p>

<h2 id="断言">断言</h2>

<p>Spring Cloud Gateway是通过predicate(断言)来匹配请求的，如可以根据请求的URL进行匹配，请求的动词进行匹配，请求头进行匹配。</p>

<blockquote>
<p>这里所说的断言其实就是Java8 java.util.function包下的Predicate<T>，它提供一个泛型参数，返回一个Boolean类型，表示传入的参数是否能匹配上某种条件。</p>
</blockquote>

<h2 id="路由">路由</h2>

<p>一个路由可以粗略地理解为一个请求的表现方式。它的类是在<code>org.springframework.cloud.gateway.route</code>包下的<code>RouteDefinition</code>定义的。它包含了
一个由<code>UUID</code>来表示的ID，一系列的断言、一系列的过滤器、uri地址、顺序和用户可自定义的元数据组成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="err">public class </span><span class="n">RouteDefinition</span> <span class="p">{</span>

	<span class="nd">@NotEmpty</span>
	<span class="err">private String </span><span class="n">id</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
	<span class="nd">@NotEmpty</span>
	<span class="nd">@Valid</span>
	<span class="err">private List</span><span class="o">&lt;</span><span class="err">PredicateDefinition&gt; predicates </span><span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
	<span class="nd">@Valid</span>
	<span class="err">private List</span><span class="o">&lt;</span><span class="err">FilterDefinition&gt; filters </span><span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
	<span class="nd">@NotNull</span>
	<span class="err">private URI </span><span class="n">uri</span><span class="p">;</span>
	<span class="err">private Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="err">Object&gt; metadata </span><span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
	<span class="err">private int </span><span class="n">order</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span>
    <span class="c1">// .....
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="实践">实践</h1>

<h2 id="引入相关依赖">引入相关依赖</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml">        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.2.0.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-pool2<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-lang3<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.9<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis-reactive<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="自定义一个新的路由">自定义一个新的路由</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># 监听端口</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>gateway<span class="p">:</span><span class="w">
</span><span class="w">      </span>routes<span class="p">:</span><span class="w"> </span><span class="c"># 路由集合</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>id<span class="p">:</span><span class="w"> </span>test<span class="w"> </span><span class="c"># 路由的ID</span><span class="w">
</span><span class="w">          </span>uri<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//abc.com<span class="w"> </span><span class="c"># 转发到后端的服务</span><span class="w">
</span><span class="w">          </span>predicates<span class="p">:</span><span class="w"> </span><span class="c"># 断言集合</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>Path=/api/orders<span class="w"> </span><span class="c"># 根据path进行匹配</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>Method=GET<span class="w"> </span><span class="c"># 根据请求方法进行匹配</span></code></pre></td></tr></table>
</div>
</div>
<p>根据上面的配置，网关启动后监听到<code>8080</code>端口。当前端以<code>GET</code>方法访问<code>http://localhost:8080/api/orders</code>的时候，网关就会将这个请求转发到<code>http://abc.com/api/orders</code>上进行处理。</p>

<h2 id="跨域配置">跨域配置</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>gateway<span class="p">:</span><span class="w">
</span><span class="w">      </span>globalcors<span class="p">:</span><span class="w">
</span><span class="w">        </span>corsConfigurations<span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="s1">&#39;[/**]&#39;</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>allowed-origins<span class="p">:</span><span class="w"> </span><span class="c"># Access-Control-Allow-Origin头中携带了服务器端验证后的允许的跨域请求域名，可以是一个具体的域名或是一个*（表示任意域名）。</span><span class="w">
</span><span class="w">              </span>-<span class="w"> </span><span class="s2">&#34;http://localhost:8081&#34;</span><span class="w">
</span><span class="w">            </span>allowed-headers<span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">            </span>exposed-headers<span class="p">:</span><span class="w"> </span><span class="c"># Access-Control-Expose-Headers头用于允许返回给跨域请求的响应头列表，在列表中的响应头的内容，才可以被浏览器访问。</span><span class="w">
</span><span class="w">              </span>-<span class="w"> </span><span class="s2">&#34;X-Powered-By&#34;</span><span class="w">
</span><span class="w">            </span>allow-credentials<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">            </span>allowed-methods<span class="p">:</span><span class="w">  </span><span class="c"># Access-Control-Allow-Methods用于告知浏览器可以在实际发送跨域请求时，可以支持的请求方法，可以是一个具体的方法列表或是一个*（表示任意方法）。</span><span class="w">
</span><span class="w">              </span>-<span class="w"> </span>GET<span class="w">
</span><span class="w">              </span>-<span class="w"> </span>POST<span class="w">
</span><span class="w">              </span>-<span class="w"> </span>OPTIONS<span class="w">
</span><span class="w">            </span>max-age<span class="p">:</span><span class="w"> </span><span class="m">3600</span><span class="w"> </span><span class="c"># Access-Control-Max-Age用于告知浏览器可以将预先检查请求返回结果缓存的时间，在缓存有效期内，浏览器会使用缓存的预先检查结果判断是否发送跨域请求。</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="自定义一个断言">自定义一个断言</h2>

<p>我们自定义一个路由是否启动的断言。及当该断言开启时才向后端服务进行转发，否则直接返回4o4。
在Spring Cloud Gateway中自定一断言（或过滤器）都非常简单，只要按照固定的命名格式即可。
我们创建一个名为<code>RouteEnableRoutePredicateFactory</code>的断言工厂。
注意：类的命名必须是<code>XXXRoutePredicateFactory</code>, 在类中继承自<code>AbstractRoutePredicateFactory</code>即可，如果断言有自己的配置，可以在泛型参数中定义自己的配置。如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="err">public class RouteEnableRoutePredicateFactory extends </span><span class="n">AbstractRoutePredicateFactory</span><span class="o">&lt;</span><span class="n">RouteEnableRoutePredicateFactory</span><span class="p">.</span><span class="na">Config</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="err">private static final Logger </span><span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">RouteEnableRoutePredicateFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="c1">// 在路由中配置断言时以该字段作为断言名称
</span><span class="c1"></span>    <span class="err">public static final String </span><span class="n">ROUTE_ENABLE</span> <span class="o">=</span> <span class="s">&#34;RouteEnable&#34;</span><span class="p">;</span> 

    <span class="err">public RouteEnableRoutePredicateFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="err">public List</span><span class="o">&lt;</span><span class="err">String&gt; shortcutFieldOrder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">ROUTE_ENABLE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="err">public Predicate</span><span class="o">&lt;</span><span class="err">ServerWebExchange&gt; apply</span><span class="p">(</span><span class="err">Config config</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">GatewayPredicate</span><span class="p">()</span> <span class="p">{</span>
            <span class="err">private ServerWebExchange </span><span class="n">exchange</span><span class="p">;</span>

            <span class="nd">@Override</span>
            <span class="err">public boolean </span><span class="n">test</span><span class="p">(</span><span class="err">ServerWebExchange exchange</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">exchange</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">config</span><span class="p">.</span><span class="na">getRouteEnable</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="nd">@Override</span>
            <span class="err">public String </span><span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%s enable status: %s&#34;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getPath</span><span class="p">().</span><span class="na">value</span><span class="p">(),</span> <span class="n">config</span><span class="p">.</span><span class="na">getRouteEnable</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="cm">/**
</span><span class="cm">     * 路由是否生效配置
</span><span class="cm">     */</span>
    <span class="err">public static class Config </span><span class="p">{</span>
        <span class="err">private Boolean </span><span class="n">routeEnable</span><span class="p">;</span>
        <span class="err">public Boolean </span><span class="n">getRouteEnable</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">routeEnable</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="err">public void </span><span class="n">setRouteEnable</span><span class="p">(</span><span class="err">Boolean routeEnable</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">routeEnable</span> <span class="o">=</span> <span class="n">routeEnable</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>gateway<span class="p">:</span><span class="w">
</span><span class="w">      </span>routes<span class="p">:</span><span class="w"> </span><span class="c"># 路由集合</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>id<span class="p">:</span><span class="w"> </span>test<span class="w"> </span><span class="c"># 路由的ID</span><span class="w">
</span><span class="w">          </span>uri<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//abc.com<span class="w"> </span><span class="c"># 转发到后端的服务</span><span class="w">
</span><span class="w">          </span>predicates<span class="p">:</span><span class="w"> </span><span class="c"># 断言集合</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>RouteEnable=<span class="kc">true</span><span class="w"> </span><span class="c"># 路由是否生效的断言</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="自定义一个过滤器">自定义一个过滤器</h2>

<p>我们来定义一个记录请求耗时的一个过滤器。
先定义一个名为<code>TimeSpentFilter</code>的类，这个类需要实现<code>GatewayFilter</code>类和<code>Ordered</code>类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="err">public class TimeSpentFilter implements </span><span class="n">GatewayFilter</span><span class="p">,</span> <span class="n">Ordered</span> <span class="p">{</span>
    <span class="err">private static final String </span><span class="n">TIME_SPENT</span> <span class="o">=</span> <span class="s">&#34;timeSpent&#34;</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="err">public Mono</span><span class="o">&lt;</span><span class="err">Void&gt; filter</span><span class="p">(</span><span class="err">ServerWebExchange exchange</span><span class="p">,</span> <span class="err">GatewayFilterChain chain</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exchange</span><span class="p">.</span><span class="na">getAttributes</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">TIME_SPENT</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">).</span><span class="na">then</span><span class="p">(</span>
                <span class="n">Mono</span><span class="p">.</span><span class="na">fromRunnable</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
                    <span class="err">Long startTime </span><span class="o">=</span> <span class="p">(</span><span class="n">Long</span><span class="p">)</span> <span class="n">exchange</span><span class="p">.</span><span class="na">getAttributes</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">TIME_SPENT</span><span class="p">);</span>
                    <span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;spent time : {}&#34;</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">);</span>
                <span class="p">})</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="err">public int </span><span class="n">getOrder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Ordered</span><span class="p">.</span><span class="na">LOWEST_PRECEDENCE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>再通过一个过滤器工厂将其注入到Spring环境中。类的命名要以<code>GatewayFilterFactory</code>结尾并实现<code>GatewayFilterFactory</code>类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="err">public class TimeSpentGatewayFilterFactory implements </span><span class="n">GatewayFilterFactory</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="err">public GatewayFilter </span><span class="n">apply</span><span class="p">(</span><span class="err">Object config</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TimeSpentFilter</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="err">public Class </span><span class="n">getConfigClass</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>配置使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>gateway<span class="p">:</span><span class="w">
</span><span class="w">      </span>routes<span class="p">:</span><span class="w"> </span><span class="c"># 路由集合</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>id<span class="p">:</span><span class="w"> </span>test<span class="w"> </span><span class="c"># 路由的ID</span><span class="w">
</span><span class="w">          </span>uri<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//abc.com<span class="w"> </span><span class="c"># 转发到后端的服务</span><span class="w">
</span><span class="w">          </span>predicates<span class="p">:</span><span class="w"> </span><span class="c"># 断言集合</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>RouteEnable=<span class="kc">true</span><span class="w"> </span><span class="c"># 路由是否生效的断言</span><span class="w">
</span><span class="w">          </span>filters<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>TimeSpent<span class="w"> </span><span class="c"># 耗时统计过滤器</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="动态路由配置">动态路由配置</h2>

<p>刚才我们的配置都是存放在<code>application.yml</code>文件中的，每次配置了路由都要重启网关，这对于网关来说是不可接受的。我们可以引入配置中心来将配置动态化。
将携程的Apollo作为配置中心是个不错的选择。简化起见，这里我们以Spring Config Server作为配置中心。我们不使用Git来存储而是使用<code>MySQL</code>数据库来存储配置信息。</p>

<p>新建一个Config Server项目并引入一下依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-config-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">9090</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>config<span class="p">:</span><span class="w">
</span><span class="w">      </span>server<span class="p">:</span><span class="w">
</span><span class="w">        </span>jdbc<span class="p">:</span><span class="w">
</span><span class="w">          </span>sql<span class="p">:</span><span class="w"> </span>SELECT<span class="w"> </span>`key`<span class="p">,</span><span class="w"> </span>`value`<span class="w"> </span>from<span class="w"> </span>`properties`<span class="w"> </span>where<span class="w"> </span>application=<span class="p">?</span><span class="w"> </span>and<span class="w"> </span>profile=<span class="p">?</span><span class="w"> </span>and<span class="w"> </span>label=<span class="p">?</span><span class="w">
</span><span class="w">      </span>label<span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w">
</span><span class="w">    </span>active<span class="p">:</span><span class="w"> </span>jdbc<span class="w">
</span><span class="w">  </span>datasource<span class="p">:</span><span class="w">
</span><span class="w">    </span>url<span class="p">:</span><span class="w"> </span>jdbc<span class="p">:</span>mysql<span class="p">:</span>//<span class="m">127.0.0.1</span><span class="p">:</span><span class="m">3306</span>/spring-config-server<span class="p">?</span>useUnicode=<span class="kc">true</span><span class="cp">&amp;characterEncoding=UTF-8</span><span class="w">
</span><span class="w">    </span>username<span class="p">:</span><span class="w"> </span>admin<span class="w">
</span><span class="w">    </span>password<span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">    </span>driver-class-name<span class="p">:</span><span class="w"> </span>com.mysql.cj.jdbc.Driver<span class="w">
</span><span class="w"></span>logging<span class="p">:</span><span class="w">
</span><span class="w">  </span>level<span class="p">:</span><span class="w">
</span><span class="w">    </span>root<span class="p">:</span><span class="w"> </span>error</code></pre></td></tr></table>
</div>
</div>
<p>数据库中需要有一张表来存储配置信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">properties</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">properties</span><span class="o">`</span>  <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="k">key</span><span class="o">`</span> <span class="kt">text</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">value</span><span class="o">`</span> <span class="kt">text</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">application</span><span class="o">`</span> <span class="kt">text</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">profile</span><span class="o">`</span> <span class="kt">text</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">label</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span> <span class="k">USING</span> <span class="n">BTREE</span>
<span class="p">)</span> <span class="kp">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">221</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="o">=</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="o">=</span> <span class="n">utf8mb4_bin</span> <span class="n">ROW_FORMAT</span> <span class="o">=</span> <span class="n">Dynamic</span><span class="p">;</span>

<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>在网关处引入spring-cloud-starter-config和spring-boot-starter-actuator：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml">        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-config<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.2.1.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>我们需要使用spring-cloud-starter-config来连接Config Server， 使用spring-boot-starter-actuator来达到动态刷新配置。</p>

<p>网关配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>cloud<span class="p">:</span><span class="w">
</span><span class="w">    </span>config<span class="p">:</span><span class="w"> </span><span class="c"># 配置中心地址配置</span><span class="w">
</span><span class="w">      </span>uri<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9090</span><span class="w">
</span><span class="w">      </span>label<span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>dev<span class="w">
</span><span class="w">      </span>profile<span class="p">:</span><span class="w"> </span>dev<span class="w">
</span><span class="w">
</span><span class="w"></span>management<span class="p">:</span><span class="w"> </span><span class="c"># 使用management来动态刷新配置</span><span class="w">
</span><span class="w">  </span>server<span class="p">:</span><span class="w">
</span><span class="w">    </span>port<span class="p">:</span><span class="w"> </span><span class="m">9008</span><span class="w">
</span><span class="w">  </span>endpoint<span class="p">:</span><span class="w">
</span><span class="w">    </span>health<span class="p">:</span><span class="w">
</span><span class="w">      </span>show-details<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">  </span>endpoints<span class="p">:</span><span class="w">
</span><span class="w">    </span>web<span class="p">:</span><span class="w">
</span><span class="w">      </span>exposure<span class="p">:</span><span class="w">
</span><span class="w">        </span>include<span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>注意：上面的配置需要配置在<code>bootstrap.yml</code>文件中。</p>
</blockquote>

<p>启动网关，连接上配置中心。修改数据库中的配置信息，使用PostMan以Post方法访问<code>http://localhost:9008/actuator/refresh</code>接口就实现了动态刷新。</p>

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring/">Spring</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/pom-spring/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">从pom文件看Spring Boot用到了哪些技术</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/gitbranchmgr/">
            <span class="next-text nav-default">Gitlab版本式分支管理规范</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:igordonxiao@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
  
    <a href="https://twitter.com/igordonxiao" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
  
  
  
    <a href="https://github.com/igordonxiao" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
  
  
  
  
  
  
  
  
  
  


<a href="/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Gordon
        
      </span></span>

  <span><img src="https://travis-ci.org/igordonxiao/blog.svg?branch=master" alt="编译状态"></span>

  <br>
  <span><a target="_blank" href="http://beian.miit.gov.cn">蜀ICP备2020031828号</a></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
